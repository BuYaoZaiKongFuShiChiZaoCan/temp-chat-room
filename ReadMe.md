# 临时聊天室

别称：ThreeTwoOne （TTO）

聊天室作用：面向多平台来源用户，针对临时事件快速搭建私密聊天空间；聊天内容无持久化存储，事件到期或建立人手动结束后自动清除消息，全程保障沟通隐私性。

## 界面逻辑及流程

### 核心设计要求

1. **多端适配优先级**：以手机端适配为核心，兼顾平板 / PC 端极简适配，保证移动端操作便捷性（如单手可完成消息发送、流程阶段切换）。
2. 事件化聊天室配置
	- 建立人需配置核心信息：聊天主题、核心讨论内容、全局公告；
	- 沟通形式支持多类型并行开启：视频类（视频消息、1v1 / 多人视频通话）、音频类（语音消息、1v1 / 多人语音通话）、文字类（文本、图片、文件）、线下类（线下会议时间 / 地点同步）；
	- 流程管控能力：建立人可手动同步流程阶段（如 “需求讨论→方案确认→执行落地”），自定义流程规则（积分制、流程审批制、淘汰制等），并支持以表格、流程图、进度条等形式可视化展示当前执行状态；
	- 特殊任务约束：建立人可指定特定任务的唯一完成形式（如 “方案确认必须通过视频会议达成”“报名信息必须以文字表单提交”）。
3. 基础聊天功能
	- 核心交互：消息引用 / 回复、@群成员、群内消息已读 / 未读状态可视化（全员已读 / 部分已读 / 未读人数统计）；
	- 个性化功能：表情包快捷使用（第三方登录用户可同步平台表情包、支持自定义表情包上传）、消息撤回 / 编辑（限时）、聊天记录临时导出（仅建立人 / 授权用户）。
4. 流程与话题可视化
	- 界面内置 “事件流程入口”，实时展示当前阶段（如 “需求讨论阶段 - 第 2 天”）、上一阶段参与人数 / 核心结论；
	- 话题树状管理：自动识别并整理主题外衍生话题（如反馈问题细节讨论），以树状图展示主话题与子话题的关联关系，支持快速切换 / 收起子话题聊天窗口。

### 核心逻辑流程

#### 1. 身份验证环节（网站第一屏 / 首页）

- 登录 / 注册方式

	：支持多维度身份验证，满足不同隐私需求：

	- 快捷登录：第三方平台一键登录（微信 / QQ / 抖音 / 微博等，同步平台唯一 ID）；
	- 自主注册：手机号 + 验证码、邮箱 + 验证码 + 用户名 + 密码、身份证实名验证（可选，用于高隐私需求场景）；
	- 临时身份：支持 “一次性临时身份”（无需注册，生成临时 ID，退出即失效）、“限时身份”（自定义登录有效期：1 小时 / 1 天 / 7 天，到期自动提示重新验证）、“永久身份”（保留账号信息，下次免验证登录）；

- **隐私保障**：所有身份信息仅临时存储，临时身份数据在会话结束后自动清除，实名信息仅用于建立人身份核验，不关联聊天内容。

#### 2. 核心功能入口（网站第二屏）

- 个人中心视图：展示 “我创建的事件”“我加入的事件” 列表，标注每个事件的当前阶段、未读消息数、参与人数；
- 操作入口：“创建新事件”（跳转事件配置页）、“加入已有事件”（输入事件 ID / 扫码加入）、“历史事件记录”（仅展示事件名称 / 参与时间，无聊天内容）。

#### 3. 聊天室创建与管控（建立人专属流程）

- 建立人完成事件配置后，生成唯一事件 ID / 邀请码 / 二维码，支持定向分享至指定平台；
- 流程管控操作：实时更新流程阶段、调整沟通形式权限、修改流程规则、标记任务完成状态、导出阶段流程报告。

#### 4. 入群审核环节

- 申请人操作：手动输入申请理由 / 相关凭证（文本 / 图片 / 视频），或通过第三方平台快捷登录提交身份 ID；
- 建立人审核：可自定义审核规则（如 “优先通过第三方平台实名用户入群”“仅接受身份证验证用户申请”），支持批量审核 / 拒绝，审核通过后申请人自动加入聊天室；
- 防虚假机制：建立人可要求申请人补充验证信息（如平台账号截图、手机号二次验证），禁止非目标人群加入。

## 技术实现方案

### 核心技术栈

| 模块         | 技术选型                           | 核心作用                                                     |
| ------------ | ---------------------------------- | ------------------------------------------------------------ |
| 数据库       | MySQL                              | 存储用户身份信息（临时 / 永久）、事件配置信息、流程阶段数据、话题树结构；**聊天消息不落地存储**，仅在会话存续期缓存，结束后自动清理。 |
| 前端托管     | Cloudflare Pages                   | 托管多端适配的静态前端页面（HTML/CSS/JS/Vue/React），利用 Cloudflare 边缘节点实现全球快速访问。 |
| 动态逻辑载体 | Cloudflare Workers                 | 处理前端请求转发、MySQL 数据交互、身份验证逻辑、事件流程状态更新；结合 Workers KV 实现会话级临时缓存（存储未落地的聊天消息）。 |
| 实时通信     | Cloudflare Workers WebSocket       | 实现文字 / 语音 / 视频消息的实时推送、已读状态同步、流程阶段实时更新；保障边缘节点低延迟通信。 |
| 音视频能力   | WebRTC + Cloudflare WebRTC Gateway | 基于 WebRTC 实现点对点 / 多人音视频通话，通过 Cloudflare 网关优化音视频传输稳定性，无需自建媒体服务器。 |
| 身份认证     | Cloudflare Access                  | 补充身份验证层级，支持 IP 白名单、第三方 OIDC 登录集成，强化临时身份的安全性。 |

### 服务使用规则

1. 数据生命周期

	：

	- MySQL 仅存储非消息类核心数据（用户 ID、事件配置、流程状态），所有数据均标记 “事件关联 ID”，事件结束后自动执行批量清理；
	- 聊天消息仅缓存于 Workers KV（边缘节点内存级缓存），缓存有效期与事件存续期一致，事件结束 / 到期后立即清除，无备份 / 日志留存。

2. 权限管控

	：

	- 建立人权限：配置事件规则、审核入群申请、管控流程阶段、结束事件、导出流程报告；
	- 普通用户权限：发送 / 接收消息、查看流程状态、参与指定形式的沟通（如视频通话）、提交任务结果；
	- 临时权限：建立人可临时授权用户 “流程编辑”“子话题管理” 等权限，授权到期自动回收。

3. 隐私与合规

	：

	- 全程无聊天内容监控，所有数据传输均通过 HTTPS/WSS 加密；
	- 支持用户自主删除个人身份关联记录，临时身份数据在退出后 1 小时内彻底清除；
	- 不存储音视频通话录制文件，仅在用户主动开启 “临时录制” 时生成本地文件，无云端存储。

### 扩展能力（可选）

1. **第三方集成**：支持对接企业微信 / 钉钉机器人，同步事件流程至企业协作工具；
2. **离线消息提醒**：通过短信 / 邮件推送离线消息（需用户主动开启，仅推送消息摘要，无完整内容）；
3. **多语言适配**：支持中英文切换，满足跨平台 / 跨境临时事件沟通需求。
